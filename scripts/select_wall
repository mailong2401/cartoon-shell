#!/usr/bin/env bash

PATH_TO_CARTOON_SHELL_JSON="$HOME/.config/quickshell/cartoon-shell/config/configs/default.json"
XDG_CONFIG_HOME="${XDG_CONFIG_HOME:-$HOME/.config}"
XDG_CACHE_HOME="${XDG_CACHE_HOME:-$HOME/.cache}"
XDG_STATE_HOME="${XDG_STATE_HOME:-$HOME/.local/state}"
CONFIG_DIR="$XDG_CONFIG_HOME/quickshell/$QUICKSHELL_CONFIG_NAME"
CACHE_DIR="$XDG_CACHE_HOME/quickshell"
STATE_DIR="$XDG_STATE_HOME/quickshell"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CUSTOM_DIR="$XDG_CONFIG_HOME/hypr/custom"
RESTORE_SCRIPT_DIR="$CUSTOM_DIR/scripts"
RESTORE_SCRIPT="$RESTORE_SCRIPT_DIR/__restore_wallpaper.sh"
THUMBNAIL_DIR="$RESTORE_SCRIPT_DIR/mpvpaper_thumbnails"
VIDEO_OPTS="no-audio loop hwdec=auto video-sync=display-resample interpolation fade-in-duration=1"

# Tạo thư mục nếu chưa tồn tại
mkdir -p "$RESTORE_SCRIPT_DIR"
mkdir -p "$THUMBNAIL_DIR"

is_video() {
  local extension="${1##*.}"
  case "${extension,,}" in
  mp4 | webm | mkv | avi | mov | flv | wmv | m4v | mpg | mpeg)
    return 0
    ;;
  *)
    return 1
    ;;
  esac
}

kill_existing_mpvpaper() {
  pkill -f -9 mpvpaper || true
}

# Hàm tạo restore script cho video
create_video_restore_script() {
  local video_path="$1"
  cat >"$RESTORE_SCRIPT" <<EOF
#!/bin/bash
# Generated by select_wall.sh - Don't modify it by yourself.
# Time: $(date)

# Kiểm tra và khởi động hyprpaper nếu cần
if ! pgrep -x hyprpaper >/dev/null; then
    hyprpaper &
    sleep 1
fi

# Kill existing mpvpaper
pkill -f -9 mpvpaper

# Set video wallpaper
mpvpaper -o "$VIDEO_OPTS" "*" "$video_path" >/dev/null 2>&1 &
EOF
  chmod +x "$RESTORE_SCRIPT"
}

# Hàm tạo restore script cho ảnh
create_image_restore_script() {
  local img_path="$1"
  cat >"$RESTORE_SCRIPT" <<EOF
#!/bin/bash
# Generated by select_wall.sh - Don't modify it by yourself.
# Time: $(date)

# Kiểm tra và khởi động hyprpaper nếu cần
if ! pgrep -x hyprpaper >/dev/null; then
    hyprpaper &
    sleep 1
fi

# Xóa các wallpaper cũ
hyprctl hyprpaper unload all

# Load wallpaper mới
hyprctl hyprpaper preload "$img_path"

# Đặt wallpaper cho từng màn hình
for monitor in \$(hyprctl monitors -j | jq -r '.[] | .name'); do
    hyprctl hyprpaper wallpaper "\$monitor,$img_path"
done
EOF
  chmod +x "$RESTORE_SCRIPT"
}

set_wallpaper_path() {
  local path="$1"
  if [ -f "$SHELL_CONFIG_FILE" ]; then
    jq --arg path "$path" '.background.wallpaperPath = $path' "$SHELL_CONFIG_FILE" >"$SHELL_CONFIG_FILE.tmp" && mv "$SHELL_CONFIG_FILE.tmp" "$SHELL_CONFIG_FILE"
  fi
}

set_image_wallpaper() {
  local imgpath="$1"

  # Kiểm tra và khởi động hyprpaper nếu cần
  if ! pgrep -x hyprpaper >/dev/null; then
    hyprpaper &
    sleep 1
  fi

  # Xóa các wallpaper cũ
  hyprctl hyprpaper unload all

  # Load wallpaper mới
  hyprctl hyprpaper preload "$imgpath"

  # Đặt wallpaper cho từng màn hình
  monitors=$(hyprctl monitors -j | jq -r '.[] | .name')
  for monitor in $monitors; do
    hyprctl hyprpaper wallpaper "$monitor,$imgpath"
  done

  echo "Image wallpaper set to: $imgpath"
}

switch() {
  imgpath="$1"

  if [[ -z "$imgpath" ]]; then
    echo 'Aborted'
    exit 0
  fi

  kill_existing_mpvpaper

  if is_video "$imgpath"; then
    mkdir -p "$THUMBNAIL_DIR"

    missing_deps=()
    if ! command -v mpvpaper &>/dev/null; then
      missing_deps+=("mpvpaper")
    fi
    if ! command -v ffmpeg &>/dev/null; then
      missing_deps+=("ffmpeg")
    fi
    if [ ${#missing_deps[@]} -gt 0 ]; then
      echo "Missing deps: ${missing_deps[*]}"
      echo "Arch: sudo pacman -S ${missing_deps[*]}"
      exit 0
    fi

    # Set wallpaper path
    set_wallpaper_path "$imgpath"

    # Set video wallpaper
    local video_path="$imgpath"
    mpvpaper -o "$VIDEO_OPTS" "*" "$video_path" >/dev/null 2>&1 &

    # Tạo restore script cho video
    create_video_restore_script "$video_path"

    echo "Video wallpaper set to: $imgpath"
  else
    # Update wallpaper path in config
    set_wallpaper_path "$imgpath"

    # Set image wallpaper
    set_image_wallpaper "$imgpath"

    # Tạo restore script cho ảnh
    create_image_restore_script "$imgpath"
  fi
}

main() {
  imgpath=""

  while [[ $# -gt 0 ]]; do
    case "$1" in
    --image)
      imgpath="$2"
      shift 2
      ;;
    *)
      if [[ -z "$imgpath" ]]; then
        imgpath="$1"
      fi
      shift
      ;;
    esac
  done

  # Nếu không có đường dẫn, lấy từ config
  if [[ -z "$imgpath" ]]; then
    imgpath=$(jq -r '.background.wallpaperPath' "$SHELL_CONFIG_FILE" 2>/dev/null || echo "")
  fi

  # Nếu vẫn không có, mở file picker
  if [[ -z "$imgpath" ]]; then
    cd "$(xdg-user-dir PICTURES)/Wallpapers/showcase" 2>/dev/null || cd "$(xdg-user-dir PICTURES)/Wallpapers" 2>/dev/null || cd "$(xdg-user-dir PICTURES)" || return 1
    imgpath="$(kdialog --getopenfilename . --title 'Choose wallpaper' 2>/dev/null || echo "")"
  fi

  # Nếu có đường dẫn, chuyển wallpaper
  if [[ -n "$imgpath" && -f "$imgpath" ]]; then
    switch "$imgpath"
  else
    echo "No wallpaper selected or file not found"
  fi

  # Adding line path wallpaper into default.json

  # Cheking mode theme for gen color with matugen
  if jq -e '.theme == "dark"' "$PATH_TO_CARTOON_SHELL_JSON" >/dev/null; then
    color_mode="dark"
    ma
    matugen image $imgpath --mode $color_mode
  fi
  if jq -e '.theme == "light"' "$PATH_TO_CARTOON_SHELL_JSON" >/dev/null; then
    color_mode="light"
    matugen image $imgpath --mode $color_mode
  fi
}

main "$@"
